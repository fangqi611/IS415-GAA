{
  "hash": "e2ad630210c02711d07bb4d645196213",
  "result": {
    "markdown": "---\ntitle: \"In-Class Ex09: GRF\"\ndate: \"March 18, 2024\"\ndate-modified: \"last-modified\"\nformat: \n  html:\n    fontsize: 18px\nexecute:\n  echo: true\n  eval: true\n  freeze: true\n  warning: false\n  message: false\n  fig_retine: 3\neditor: visual\n---\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, spdep, GWmodel,\n               SpatialML, tmap, \n               tidymodels, tidyverse, \n               gtsummary,\n               rpart, rpart.plot, \n               ggstatsplot, performance)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_sf <- read_rds(\"data/rds/HDB_resale.rds\")\n```\n:::\n\n\nThe code chunk below is used to reveal the properties f *rs_sf* object.\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nresale_split <- initial_split(\n  rs_sf,\n  prop = 5/10,)\ntrain_sf <- training(resale_split)\ntest_sf <- testing(resale_split)\n```\n:::\n\n\n# 1. Converting from sf objects to data.frame gwModel and spatial ML libraries require the input data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_df <- train_sf %>%\n  st_drop_geometry() %>%\n  as.data.frame()\n\ntest_df <- test_sf %>%\n  st_drop_geometry() %>%\n  as.data.frame()\n```\n:::\n\n\n## Saving the output files\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(train_df, \"data/models/train_df.rds\")\nwrite_rds(test_df, \"data/models/test_df.rds\")\n```\n:::\n\n\n## Retriving the Stored Data\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_df <- read_rds(\"data/rds/train_df.rds\")\ntest_df <- read_rds(\"data/rds/test_df.rds\")\n```\n:::\n\n\n# 2. Computing correlation matrix\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_sf1 <- rs_sf %>%\n  st_drop_geometry()\nggcorrmat(rs_sf1[,2:17])\n```\n\n::: {.cell-output-display}\n![](In-Class_Ex09_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n# 3. Building a Non-spatial Multiple Linear Regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_mlr <- lm(formula = RESALE_PRICE ~\n               FLOOR_AREA_SQM +\n               STOREY_ORDER +\n               REMAINING_LEASE_MTHS +\n               PROX_CBD +\n               PROX_ELDERLYCARE +\n               PROX_HAWKER +\n               PROX_MRT +\n               PROX_PARK +\n               PROX_GOOD_PRISCH +\n               PROX_MALL +\n               PROX_SUPERMARKET +\n               WITHIN_350M_KINDERGARTEN +\n               WITHIN_350M_CHILDCARE +\n               WITHIN_350M_BUS +\n               WITHIN_1KM_PRISCH,\n             data = train_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntbl_regression(rs_mlr, \n               intercept = TRUE) %>% \n  add_glance_source_note(\n    label = list(sigma ~ \"\\U03C3\"),\n    include = c(r.squared, adj.r.squared, \n                AIC, statistic,\n                p.value, sigma))\n```\n:::\n\n\nYou need to explicit say one is x and the other is y\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(rs_sf)\ncoords_train <- st_coordinates(train_sf)\ncoords_test <- st_coordinates(train_sf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- performance::check_collinearity(\n  rs_mlr)\nplot(p)\n```\n:::\n\n\n# 4. Revising mlr model\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_df <- train_df %>%\n  select(-c(PROX_CHAS))\ntrain_sf <- train_sf %>%\n  select(-c(PROX_CHAS))\ntest_df <- test_df %>%\n  select(-c(PROX_CHAS))\ntest_sf <- test_sf %>%\n  select(-c(PROX_CHAS))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(train_sf, \"data/rds/train_sf.rds\")\nwrite_rds(train_df, \"data/rds/train_df.rds\")\nwrite_rds(test_sf, \"data/rds/test_sf.rds\")\nwrite_rds(test_df, \"data/rds/test_df.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_mlr <- lm(formula = RESALE_PRICE ~ \n               FLOOR_AREA_SQM +\n               STOREY_ORDER +\n               REMAINING_LEASE_MTHS +\n               PROX_CBD + \n               PROX_ELDERLYCARE + \n               PROX_HAWKER +\n               PROX_MRT + \n               PROX_PARK + \n               PROX_GOOD_PRISCH +\n               PROX_MALL + \n               PROX_SUPERMARKET +\n               WITHIN_350M_KINDERGARTEN +\n               WITHIN_350M_CHILDCARE +\n               WITHIN_350M_BUS +\n               WITHIN_1KM_PRISCH,\n             data=train_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntbl_regression(rs_mlr, \n               intercept = TRUE) %>% \n  add_glance_source_note(\n    label = list(sigma ~ \"\\U03C3\"),\n    include = c(r.squared, adj.r.squared, \n                AIC, statistic,\n                p.value, sigma))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords_train <- write_rds(coords_train, \"data/models/coords_train.rds\" )\ncoords_test <- write_rds(coords_test, \"data/models/coords_test.rds\" )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(rs_mlr, \n          \"data/models/rs_mlr.rds\" ) \n```\n:::\n\n\n# 5. Converting the sf data.frame to SpatialPointDataFrame\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_sp <- as_Spatial(train_sf)\ntrain_sp\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nclass       : SpatialPointsDataFrame \nfeatures    : 7950 \nextent      : 11597.31, 42623.63, 28217.39, 48741.06  (xmin, xmax, ymin, ymax)\ncrs         : +proj=tmerc +lat_0=1.36666666666667 +lon_0=103.833333333333 +k=1 +x_0=28001.642 +y_0=38744.572 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \nvariables   : 17\nnames       : RESALE_PRICE, FLOOR_AREA_SQM, STOREY_ORDER, REMAINING_LEASE_MTHS,          PROX_CBD,     PROX_ELDERLYCARE,        PROX_HAWKER,           PROX_MRT,          PROX_PARK,   PROX_GOOD_PRISCH,        PROX_MALL,            PROX_CHAS,     PROX_SUPERMARKET, WITHIN_350M_KINDERGARTEN, WITHIN_350M_CHILDCARE, ... \nmin values  :       218000,             74,            1,                  555, 0.999393538715878, 1.98943787433087e-08, 0.0333358643817954, 0.0220407324774434, 0.0441643212802781, 0.0652540365486641,                0, 6.20621206270077e-09, 1.21715176356525e-07,                        0,                     0, ... \nmax values  :      1186888,            126,           17,                 1164,  19.6500691667807,     3.30163731686804,   2.80329916478192,   2.13060636038504,   2.41313695915468,   10.6223726149914, 2.26056404492346,    0.808332738794272,     1.57131703651196,                        7,                    20, ... \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_sp <- test_sf %>%\n  as_Spatial()\ntest_sp\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nclass       : SpatialPointsDataFrame \nfeatures    : 7951 \nextent      : 11597.31, 42623.63, 28287.8, 48741.06  (xmin, xmax, ymin, ymax)\ncrs         : +proj=tmerc +lat_0=1.36666666666667 +lon_0=103.833333333333 +k=1 +x_0=28001.642 +y_0=38744.572 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs \nvariables   : 17\nnames       : RESALE_PRICE, FLOOR_AREA_SQM, STOREY_ORDER, REMAINING_LEASE_MTHS,         PROX_CBD,     PROX_ELDERLYCARE,        PROX_HAWKER,           PROX_MRT,          PROX_PARK,   PROX_GOOD_PRISCH,        PROX_MALL,            PROX_CHAS,     PROX_SUPERMARKET, WITHIN_350M_KINDERGARTEN, WITHIN_350M_CHILDCARE, ... \nmin values  :       230888,             74,            1,                  546, 1.00583660772922, 3.34897933104965e-07, 0.0333358643817954, 0.0414043955932523, 0.0441643212802781, 0.0907500295577619,                0, 4.55547870890763e-09, 1.21715176356525e-07,                        0,                     0, ... \nmax values  :      1088000,            138,           14,                 1151,  19.632402730488,     3.30163731686804,   2.86763031236184,   2.13060636038504,   2.41313695915468,   10.6169590126272, 2.27100643784442,    0.808332738794272,     1.53786629004208,                        7,                    16, ... \n```\n:::\n:::\n\n\n## Extracting Coordinates Data\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(rs_sf)\ncoords_train <- st_coordinates(train_sf)\ncoords_test <- st_coordinates(test_sf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords_train <- write_rds(coords_train, \"data/models/coords_train.rds\" )\ncoords_test <- write_rds(coords_test, \"data/models/coords_test.rds\" )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_df <- train_sf %>% \n  st_drop_geometry()\n```\n:::\n\n\n## Calibrating Predictive Model: Recursive Partitioning method\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nrs_rp <- rpart(\n  formula = RESALE_PRICE ~ \n    FLOOR_AREA_SQM +\n    STOREY_ORDER +\n    REMAINING_LEASE_MTHS +\n    PROX_CBD + \n    PROX_ELDERLYCARE + \n    PROX_HAWKER +\n    PROX_MRT + \n    PROX_PARK + \n    PROX_GOOD_PRISCH +\n    PROX_MALL + \n    PROX_SUPERMARKET +\n    WITHIN_350M_KINDERGARTEN +\n    WITHIN_350M_CHILDCARE +\n    WITHIN_350M_BUS +\n    WITHIN_1KM_PRISCH,\n    data = train_df)\nrs_rp\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nn= 7950 \n\nnode), split, n, deviance, yval\n      * denotes terminal node\n\n 1) root 7950 1.139546e+14 433705.6  \n   2) PROX_CBD>=7.974483 6665 4.472144e+13 403736.0  \n     4) REMAINING_LEASE_MTHS< 1020.5 4228 1.573100e+13 370187.4  \n       8) PROX_GOOD_PRISCH>=3.629405 2271 3.851141e+12 340796.1 *\n       9) PROX_GOOD_PRISCH< 3.629405 1957 7.641480e+12 404294.6 *\n     5) REMAINING_LEASE_MTHS>=1020.5 2437 1.597594e+13 461940.1  \n      10) PROX_CBD>=10.40657 2331 9.762718e+12 451754.4  \n        20) PROX_GOOD_PRISCH>=4.866983 1123 2.801796e+12 423493.8 *\n        21) PROX_GOOD_PRISCH< 4.866983 1208 5.230246e+12 478026.4 *\n      11) PROX_CBD< 10.40657 106 6.532500e+11 685929.1 *\n   3) PROX_CBD< 7.974483 1285 3.219685e+13 589151.4  \n     6) REMAINING_LEASE_MTHS< 930.5 745 6.613365e+12 486637.6  \n      12) FLOOR_AREA_SQM< 98.5 451 2.446537e+12 442460.5 *\n      13) FLOOR_AREA_SQM>=98.5 294 1.936449e+12 554405.7 *\n     7) REMAINING_LEASE_MTHS>=930.5 540 6.952722e+12 730582.5  \n      14) REMAINING_LEASE_MTHS< 1071.5 314 2.461969e+12 676641.3 *\n      15) REMAINING_LEASE_MTHS>=1071.5 226 2.307737e+12 805527.4 *\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrpart.plot(rs_rp)\n```\n\n::: {.cell-output-display}\n![](In-Class_Ex09_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n# 6. Calibrating Random Forest Model\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nrs_rf <- ranger(\n  formula = RESALE_PRICE ~\n               FLOOR_AREA_SQM +\n               STOREY_ORDER +\n               REMAINING_LEASE_MTHS +\n               PROX_CBD +\n               PROX_ELDERLYCARE +\n               PROX_HAWKER +\n               PROX_MRT +\n               PROX_PARK +\n               PROX_GOOD_PRISCH +\n               PROX_MALL +\n               PROX_SUPERMARKET +\n               WITHIN_350M_KINDERGARTEN +\n               WITHIN_350M_CHILDCARE +\n               WITHIN_350M_BUS +\n               WITHIN_1KM_PRISCH,\n               data = train_df,\n               importance = \"impurity\")\n\nrs_rf\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRanger result\n\nCall:\n ranger(formula = RESALE_PRICE ~ FLOOR_AREA_SQM + STOREY_ORDER +      REMAINING_LEASE_MTHS + PROX_CBD + PROX_ELDERLYCARE + PROX_HAWKER +      PROX_MRT + PROX_PARK + PROX_GOOD_PRISCH + PROX_MALL + PROX_SUPERMARKET +      WITHIN_350M_KINDERGARTEN + WITHIN_350M_CHILDCARE + WITHIN_350M_BUS +      WITHIN_1KM_PRISCH, data = train_df, importance = \"impurity\") \n\nType:                             Regression \nNumber of trees:                  500 \nSample size:                      7950 \nNumber of independent variables:  15 \nMtry:                             3 \nTarget node size:                 5 \nVariable importance mode:         impurity \nSplitrule:                        variance \nOOB prediction error (MSE):       756236996 \nR squared (OOB):                  0.9472481 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nvi <- as.data.frame(rs_rf$variable.importance)\nvi$variables <- rownames(vi)\nvi <- vi %>%\n  rename(vi = \"rs_rf$variable.importance\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = vi,\n       aes(x = vi,\n           y = reorder(variables, vi))) +\n  geom_bar(stat = \"identity\")\n```\n\n::: {.cell-output-display}\n![](In-Class_Ex09_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n## Calibrating Geographical Random Forest Model\n\n::: {.cell}\n\n```{.r .cell-code}\ngrf_bw_adp <- grf.bw(\n  formula = RESALE_PRICE ~ \n    FLOOR_AREA_SQM +\n    STOREY_ORDER +\n    REMAINING_LEASE_MTHS +\n    PROX_CBD + \n    PROX_ELDERLYCARE + \n    PROX_HAWKER +\n    PROX_MRT + \n    PROX_PARK + \n    PROX_GOOD_PRISCH +\n    PROX_MALL + \n    PROX_SUPERMARKET +\n    WITHIN_350M_KINDERGARTEN +\n    WITHIN_350M_CHILDCARE +\n    WITHIN_350M_BUS +\n    WITHIN_1KM_PRISCH,\n    dataset = train_df,\n    kernel= \"adaptive\",\n    coords= coords_train,\n    bw.min = 25,\n    bw.max = 60,\n    step = 1,\n    nthreads = 16,\n    forest = FALSE,\n    weighted = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nrs_grf <- grf(formula = RESALE_PRICE ~ \n    FLOOR_AREA_SQM +\n    STOREY_ORDER +\n    REMAINING_LEASE_MTHS +\n    PROX_CBD + \n    PROX_ELDERLYCARE + \n    PROX_HAWKER +\n    PROX_MRT + \n    PROX_PARK + \n    PROX_MALL + \n    PROX_SUPERMARKET +\n    WITHIN_350M_KINDERGARTEN +\n    WITHIN_350M_CHILDCARE +\n    WITHIN_350M_BUS +\n    WITHIN_1KM_PRISCH,\n    dframe=train_df, \n    bw=55,\n    kernel=\"adaptive\",\n    coords=coords_train)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(rs_grf, \n          \"data/models/rs_grf.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_grf <- read_rds(\"data/models/rs_grf.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_df <- cbind(test_sf, coords_test) %>%\n  st_drop_geometry()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngrf_pred <- predict.grf(rs_grf, \n                        test_df,\n                        x.var.name = \"X\",\n                        y.var.name = \"Y\",\n                        local.w= 1,\n                        global.w=0)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngrf_pred <- read_rds(\"data/models/grf_pred.rds\")\ngrf_pred_df <- as.data.frame(grf_pred)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_pred <- test_df %>%\n  select(RESALE_PRICE) %>%\n  cbind(grf_pred_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrf_pred <- predict(rs_rf, test_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrf_pred_df <- as.data.frame(rf_pred$predictions) %>%\n  rename(rf_pred = \"rf_pred$predictions\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_pred <- cbind(test_pred, \n                   rf_pred_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmlr_pred <- predict(rs_mlr, test_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmlr_pred_df <- as.data.frame(mlr_pred) %>%\n  rename(mlr_pred = \"mlr_pred\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_pred <- cbind(test_pred,\n                   mlr_pred_df)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nyardstick::rmse(test_pred, \n                RESALE_PRICE, \n                grf_pred)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nyardstick::rmse(test_pred, \n                RESALE_PRICE, \n                rf_pred)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nyardstick::rmse(test_pred,\n                RESALE_PRICE,\n                mlr_pred)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmc <- test_pred %>%\n  pivot_longer(cols = c(2:4),\n               names_to = \"models\",\n               values_to = \"predicted\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmc %>% \n  group_by(models) %>%\n  yardstick::rmse(RESALE_PRICE, \n                  predicted)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = test_pred,\n       aes(x = grf_pred,\n           y = RESALE_PRICE)) +\n  geom_point()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mc,\n       aes(x = predicted,\n           y = RESALE_PRICE)) +\n  geom_point() +\n  facet_grid(. ~ models)\n```\n:::\n",
    "supporting": [
      "In-Class_Ex09_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}